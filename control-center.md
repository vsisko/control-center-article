Введение

## Обзор функционала

Представим, что Вам нужно настроить мониторинг распределённой базы данных, такой как GridGain. Метрики положим в Prometheus. Графики нарисуем в Grafana. Про систему оповещения не забудем – для этого настроим Zabbix. Для анализа трейсов воспользуемся Jaeger.

Для управления состоянием и CLI хорош. А для SQL запросов воспользуемся бесплатным JDBC клиентом вроде DBeaver.

Теперь настраиваем для каждого из инструментов систему аутентификации, чтобы никакая информация не просочилась, и мы у цели. В итоге получили связку инструментов, которая сложнее самой распределённой системы, ради которой всё затевалось.

Действительно есть компании, готовые идти по данному пути, но как правило, для настройки и поддержки подобной системы требуется целая команда специалистов и большое количество ресурсов.

### Какие ещё есть варианты?

Задачу можно сильно облегчить, не теряя при этом в возможностях. В арсенале GridGain имеется инструмент под названием Control Center, который покрывает значительную часть задач по отслеживанию состояния кластера, траблшутингу, базовому менеджменту, снятию бэкапов и прочему. Control Center предоставляет единый интерфейс, интегрированный и разработанный специально для GridGain, и максимально учитывающий его особенности. Control Center умеет работать с GridGain версии начиная с 8.7.23 любой редакции, а также с Apache Ignite версии не младше 2.8.1.

Давайте взглянем подробнее на то, для чего Control Center хорош.

### Настройка

Перед командой разработки Control Center стояла задача сделать настройку кластера для мониторинга максимально простой. Для старта Вам нужно будет скопировать модуль `control-center-agent` из директории `libs/optional` в `libs` в дистрибутиве GridGain. После старта узла в логах можно будет найти ссылку, пройдя по которой, Вы попадёте на экран мониторинга на сайте [control.gridgain.com](control.gridgain.com). На этом настройка завершена.

Также Control Center можно запустить в собственном окружении и настроить кластер для мониторинга через него при помощи команды `bin/management.sh --uri <URI>`.

Для Apache Ignite первый шаг процедуры несколько отличается, так как агент не поставляется в дистрибутиве, но его можно скачать на сайте GridGain: https://www.gridgain.com/resources/download#controlcenter.

Процесс настройки подробно описан в документации: https://www.gridgain.com/docs/control-center/latest/connect-gridgain-cluster

### Отображение метрик

Основой любой системы мониторинга является возможность работы с метриками. В Control Center данной функциональности уделено особое внимание. Экран Dashboard предлагает возможность настройки "виджетов" на основе метрик, поступающих из кластера. Среди доступных способов визуализации на данный момент есть график, гистограмма, таблица и тепловая карта (heat map). Также есть виджеты специального вида как список узлов и визуализация ребаланса.

Dashboard может содержать набор данных виджетов в любом удобном расположении друг относительно друга. Dashboard-ов может быть несколько, что позволяет создавать специализированные экраны мониторинга определённых подсистем GridGain. Например, экран мониторинга состояния региона данных может выглядеть следующим образом.

![Экран мониторинга состояния региона данных](https://habrastorage.org/webt/ck/sg/04/cksg04mdbn3rqti7_bjru_lpsiq.png)

### Настройка уведомлений

Метрики могут служить не только для визуального отображения информации. На основе них также можно настроить уведомления, которые будут срабатывать при удовлетворении указанных условий. Если Вы беспокоитесь за то, что память на одном из Ваших серверов переполнится, данное беспокойство можно облегчить, настроив уведомление по SMS или Email. Если соответствующая метрика пересечёт указанный предел, и продержится на таком уровне достаточное время, то Вам придёт об этом сообщение.

<img alt="Сообщение от сервиса уведомлений" src="https://habrastorage.org/webt/6y/e1/7a/6ye17asqjhht5ug_5uh0r40hf3a.png" width="400">

### Трейсинг

Многие операции в кластере требуют взаимодействия между разными узлами. В случае неполадок или задержек бывает сложно определить какой узел является виновником и на какой стадии возникла проблема.
Трейсинг – одно из нововведений в GridGain и Apache Ignite, упрощающее анализ таких ситуаций. Это фреймворк, позволяющий отслеживать исполнение операций, даже если они имеют распределённый характер. Каждый этап исполнения (span) логируется и привязывается к операции, для которой данное отслеживание (trace) было запущено. Все транзакции в кластере могут быть отслежены, и для самых долгих из них есть возможность найти этап, занявший наибольшее количество времени. Хоть трейсинг и появился в GridGain совсем недавно, его поддержка уже реализована в Control Center.

Самая важная информация, относящаяся к трейсам, находится на видном месте, чтобы не было необходимости долго её искать.

![Экран трейсинга](https://habrastorage.org/webt/fg/1d/qk/fg1dqkuqqqggdffpcbq23rrb7-4.png)

Подробные детали для каждого спана также доступны.

![Детали спанов](https://habrastorage.org/webt/dr/-e/uh/dr-euh3xqzfc60eu7f2bzewcgso.png)

### Запуск SQL

У GridGain есть возможность работы с данными при помощи SQL. Для выполнения задач, связанных с SQL запросами, в Control Center есть отдельная секция. Там вы найдёте редактор кода с базовыми возможностями подсветки синтаксиса и автоподстановкой. Можно иметь несколько вкладок с запросами, которые сохраняются между запусками.

![SQL редактор](https://habrastorage.org/webt/1n/rx/9z/1nrx9zl1rbtn_cec2qyexuq-l1q.png)

Запросы, выполняющиеся в текущий момент, можно найти на отдельной вкладке.

![Запущенные запросы](https://habrastorage.org/webt/wk/al/6g/wkal6gxdlmi0rzvsl1vdpnvag30.png)

Также здесь можно найти статистику по запросам с информацией о числе запусков, падений и времени исполнения.

![Статистика запросов](https://habrastorage.org/webt/dt/oj/g5/dtojg5imhfp7ss18w3ewqmv4e74.png)

### Создание снимков данных

GridGain Ultimate Edition предлагает функционал снятия снимков данных, позволяющий зафиксировать набор записей, присутствующий в кластере на момент начала создания снимка. При этом остановка работы кластера не требуется. Для работы со снимками в Control Center есть отдельная секция, где Вы можете создать новый снимок, а также применить, проверить или переместить существующий. Поддерживается работа с полными и инкрементальными снимками, со сжатием и без.

![Список снимков данных](https://habrastorage.org/webt/uf/xg/qk/ufxgqkslw7tq7lhaobfxv3n7s5u.png)

### Управление кластерами

Такие административные действия как активация и деактивация, изменение набора узлов в базовой топологии, настройка новых кластеров для мониторинга, собраны на отдельном экране Control Center. Здесь Вы можете посмотреть на список своих кластеров или выполнить действия по настройке, для которых обычно требуется CLI. Это весьма полезный экран для администраторов, производящих работу над кластером, требующую ввода или вывода узлов из топологии.

![Экран управления](https://habrastorage.org/webt/jn/uo/zj/jnuozju4xoc-3_2k5m_xfog9nnq.png)

## Архитектура

Теперь рассмотрим, как Control Center устроен. Посмотрим на то, как происходит взаимодействие с кластером, как хранится служебная информация, и какие внутренние возможности GridGain используются в реализации Control Center.

### Агент

Связующим звеном между Control Center и кластером выступает агент, функционирующий как часть каждого узла. Control Center Agent интегрирован с GridGain посредством API для плагинов. Если в classpath узла имеется соответствующий модуль, плагин инициализируется и устанавливает связь с Control Center. Взаимодействие между агентом и Control Center происходит по протоколу STOMP поверх Web Socket. 

Одновременно только один агент работает в активном режиме и имеет соединение с Control Center. Остальные агенты в это время находятся в режиме ожидания. Если узел с активным агентом выходит из топологии, происходит выбор нового ответственного узла. Тот факт, что агент запускается в том же процессе, что и сам узел, упрощает установку и поддержку инфраструктуры мониторинга. Также в такой схеме у агента есть возможность пользоваться Java API узла напрямую вместо отправки запросов в кластер снаружи через внешнее API.

<details>
  <summary markdown="span">Как было раньше</summary>

  Альтернативный вариант связи с кластером был реализован в другом инструменте мониторинга от GridGain – Web Console, на смену которого пришёл Control Center. В Web Console агент работает в отдельном процессе и связывается с кластером посредством REST API. Такая схема несёт в себе трудности при настройке и поддержке дополнительного компонента, сложности с обеспечением его отказоустойчивости и безопасности проходящего через него трафика. В связи с множественными отзывами от пользователей, эта схема была заменена на более простую.
</details>

### Добавление кластера к учётной записи

Как было продемонстрировано ранее, для начала мониторинга кластера необходимо воспользоваться специальным временным токеном. В такой схеме участвуют три идентификатора:

- **Cluster ID** – значение, генерируемое один раз за всё время работы кластера. Оно служит как уникальный идентификатор кластера во внутренних структурах Control Center. Каждый запрос в кластер или информация, поступающая из него, сопровождается данным идентификатором. Он является внутренней деталью реализации, но может быть замечен пользователем, например как часть URL в адресной строке браузера.

- **Cluster Secret** – значение, парное к *Cluster ID*. Оно служит для подтверждения аутентичности кластера. Если злоумышленник каким-то образом получит доступ к чужому *Cluster ID*, то он не сможет подключить свой кластер с тем же идентификатором, так как у него не получится пройти проверку на соответствие *Cluster ID* и *Cluster Secret*.

- **Connection Token** – временный токен, который может быть использован один раз для подключения кластера к учётной записи пользователя. 

При подключении кластера к Control Center происходит проверка соответствия его *Cluster ID* и *Cluster Secret*. Если проверка прошла успешно, то генерируется *Connection Token*. Информация о соответствии между *Cluster ID* и *Cluster Secret*, а также между *Cluster ID* и *Connection Token* хранится на стороне бэк-энда Control Center.

Ссылка, отображаемая в логах узлов кластера, содержит в себе *Cluster ID* и *Connection Token*. Кластер привязывается к учётной записи, которая была активна на момент открытия ссылки. Если пользователь не был аутентифицирован в Control Center, то будет создана временная учётная запись. Её можно превратить в постоянную, задав пароль и указав недостающие данные в настройках. Также токеном можно воспользоваться напрямую через пользовательский интерфейс без использования ссылки.

### Метрики

В Apache Ignite и GridGain существует и находится в активной стадии проект по разработке фреймворка, позволяющего упростить работу с метриками. Все метрики в системе регистрируются в единый реестр, из которого их можно экспортировать в удобном для конкретной цели формате. О подробностях можно узнать [в соответствующем IEP](https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=112820392).

Интересной для Control Center является возможность реализации exporter-а метрик, который может быть использован для пересылки метрик из GridGain в стороннюю систему мониторинга. Control Center активно пользуется данным фреймворком и имеет свою реализацию exporter-а. Раз в установленный период времени агент собирает с кластера необходимые метрики и отправляет их в Control Center. Там они обрабатываются, сохраняются в базу и отправляются пользователям при наличии соответствующих браузерных сессий.

### Трейсы

В GridGain и Apache Ignite находится в активной разработке функционал по сбору трейсов – структурированной истории выполнения операций с указанием длительности каждого из этапов. На данный момент есть возможность сбора информации о работе следующих компонентов: Discovery SPI, Partition Map Exchange, Transactions, Communication. В будущем планируется покрытие и остальных компонентов.

Трейсинг GridGain совместим с OpenCensus API. Все трейсы и спаны регистрируются в фреймворке OpenCensus, после чего поступают в специальный компонент для экспорта информации о спанах – [SpanExporter](https://www.javadoc.io/doc/io.opencensus/opencensus-api/latest/io/opencensus/trace/export/SpanExporter.html). Как и в случае с метриками, Control Center имеет свою реализацию exporter-а, которая находится в агенте. 

Спаны в рамках одного трейса могут быть записаны на разных узлах кластера. Это даёт возможность анализа распределённых операций. Каждый спан имеет ссылку на своего родителя – операцию, которая породила текущую операцию. Собрав все спаны в рамках одного трейса воедино, можно представить пошаговую древовидную историю исполнения. Для этого каждый из узлов периодически отправляет информацию о спанах, зарегистрированных локально, на узел, имеющий активное соединение с Control Center. Когда все спаны в рамках одного трейса собраны на backend-е Control Center, такой спан готов к отображению пользователю.

### Хранение данных

Выбор базы данных для хранения системной информации оказался не слишком сложной задачей. GridGain отлично справляется с хранением информации о пользователях и настройках, а также с большим потоком поступающих метрик и трейсов. В целях отказоустойчивости данные о пользователях, трейсах и метриках хранятся раздельно. Таким образом, выход из строя хранилища трейсов никак не влияет на функционал отображения графиков, основанных на метриках. Каждый из данных кластеров можно настраивать и оптимизировать отдельно, учитывая специфику приходящейся нагрузки.

Под капотом Control Center использует как интеграцию GridGain со Spring Data, так и Cache API напрямую. Инициализация состояния базы, генерация запросов и миграции реализованы при помощи механизмов Spring Data. В некоторых случаях базовых возможностей Spring Data оказалось недостаточно, поэтому интеграция была улучшена. Так, например, была добавлена поддержка [Querydsl](http://www.querydsl.com/). [Соответствующее улучшение в Apache Ignite](https://issues.apache.org/jira/browse/IGNITE-13133) на данный момент находится на этапе code review.

История метрик и трейсов хранится в GridGain только ограниченное время – один день в случае метрик и неделю в случае трейсов. После этого данная информация удаляется согласно [expiry policy](https://www.gridgain.com/docs/latest/developers-guide/configuring-caches/expiry-policies#:~:text=Expiry%20Policy%20specifies%20the%20amount,last%20access%2C%20or%20modification%20time.), настроенной в GridGain.

## Чего не хватает?

Несмотря на имеющиеся широкие возможности Control Center, активная разработка не останавливается. Всё ещё имеется ряд мест, которые предстоит разработать или улучшить.

Вот список самых значимых планируемых доработок:

- Переработка механизма взаимодействия с фреймворком метрик. В скором будущем появится возможность задания шаблонов, по которым метрики будут отображаться на графиках. Сейчас для выбора доступен только преднастроенный набор шаблонов.
- Интеграция отображения метрик и уведомлений о неполадках. Если для метрики настроено уведомление, это должно быть отражено на соответствующем графике.
- Расширение набора поддерживаемых компонентов, доступных для трейсинга. Данная работа ведётся на стороне Core GridGain и Apache Ignite.
- Интеграция с OpenID Connect и LDAP. Сейчас в Control Center доступна только нативная аутентификация, но в скором будущем появится возможность аутентификации через сторонние сервисы, такие как Google, Microsoft, Okta и т.д. Также планируется реализация механизма Single-Sign-On через OpenID Connect. Так, если в кластере настроена аутентификация через тот же сторонний сервис, что и для Control Center, повторная аутентификация в кластере не потребуется.
- Поддержка [GridGain Data Center Replication](https://www.gridgain.com/docs/latest/administrators-guide/data-center-replication/introduction). Будут добавлены возможности по управлению и мониторингу процесса репликации между разными кластерами GridGain.

## Ссылки и дополнительные материалы

- Сайт GridGain Control Center: https://control.gridgain.com/
- On-premises версия Control Center: https://www.gridgain.com/resources/download#controlcenter
- Документация Control Center: https://www.gridgain.com/docs/control-center/latest/overview
- Видео обзор возможностей Control Center (на английском): https://www.youtube.com/watch?v=6Ra_5agkeY4
- Пример подключения кластера Apache Ignite к Control Center (на русском): https://www.youtube.com/watch?v=5Dcn_8TWQuU